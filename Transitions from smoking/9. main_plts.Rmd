---
title: "Publication plots - transitions from smoking to e-cigarette use/Neither use in ALSPAC"
author: "Alexandria Andrayas"
date: "29/01/2024"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
editor_options: 
  chunk_output_type: console
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Load packages and get data

```{r load-packages}
library(ggplot2)
library(ggtext)
library(haven)
library(labelled)
library(sticky)
library(dplyr)
library(tidyr)
library(gtsummary)
library(ggpubr)
library(extrafont)
library(mice)
#library(tidycmprsk)
#library(ggsurvfit)
#font_import()
#loadfonts(device="win")
```

# Get data and specify labels

```{r data-labs}
# set up data
subdf <- read_dta('//path/to/ieu/project/folder/working/data/vaping_transitions/vaping_sub_measures.dta')
subdf <- to_factor(subdf, sort_levels='auto')
subdf <- data.frame(subdf)
subdf <- sticky_all(subdf)
subdf$id <- 1:nrow(subdf)

# 4 baseline exposures
confounders <- c('sex', 'ethnicity', 'hhincome_11', 'parent_dailsmk_12')

# 11 main exposures
main_exp <- c('freqsmk_21', 'bingalc_20', 'cana_20', 'drug_20', 'friends_smk_20', 'qual_20', 'parent_21', 'townsend_21_gr', 'bmi_18_gr', 'exerc_18', 'mfq_21_gr')

# 5 timepoints
vaps <- c('vap22', 'vap23', 'vap24', 'vap28', 'vap30')

# imputed data
load('//path/to/ieu/project/folder/working/data/vaping_transitions/vaping_impdfs.rda')
impdfs <- lapply(impdfs, function(x){
  x[,'id'] <- 1:nrow(x)
  return(x)
})

load('//path/to/ieu/project/folder/working/data/vaping_transitions/vaping_imp.rda')
long_impdf <- complete(imp, 'long')
#convert firstevent to factor
long_impdf$firstevent <- factor(long_impdf$firstevent, levels=c(1:4), labels=c('No event','Dual use','Exclusive e-cigarette use','Neither use'))

round(prop.table(table(long_impdf$firstevent)),2)
round(prop.table(table(subdf$firstevent)),2)
```

# Descriptive stats tables

```{r desc-stats}
desc_tab <- tbl_summary(subdf[, c(confounders, main_exp)], statistic = all_continuous() ~ "{mean} ({sd})", type = all_dichotomous() ~ "categorical", missing = 'no') %>%
  bold_labels() %>%
  italicize_levels() %>%
  add_n(statistic = "{n_miss} ({p_miss}%)") %>%
  modify_header(n = "**Missing**")

desc_tab |> 
  as_gt() |> 
  gt::gtsave(filename = 'C:/path/to/user/outputs/folder/descstats_tab.docx')

desc_tabs_byoutcomes <- tbl_merge(tbls = list(
  tbl_summary(subdf[, c(confounders, main_exp, 'nonuse')], by=nonuse, statistic=all_continuous() ~ "{mean} ({sd})", type = all_dichotomous() ~ "categorical", missing = 'no') %>% add_p(),
  tbl_summary(subdf[, c(confounders, main_exp, 'exclecig')], by=exclecig, statistic=all_continuous() ~ "{mean} ({sd})", type = all_dichotomous() ~ "categorical", missing = 'no') %>% add_p(),
  tbl_summary(subdf[, c(confounders, main_exp, 'dual')], by=dual, statistic=all_continuous() ~ "{mean} ({sd})", type = all_dichotomous() ~ "categorical", missing = 'no') %>% add_p(),
  tbl_summary(subdf[, c(confounders, main_exp, 'ecig')], by=ecig, statistic=all_continuous() ~ "{mean} ({sd})", type = all_dichotomous() ~ "categorical", missing = 'no') %>% add_p(),
  tbl_summary(subdf[!is.na(subdf$firstevent), c(confounders, main_exp)], statistic=all_continuous() ~ "{mean} ({sd})", type = all_dichotomous() ~ "categorical", missing = 'no')
  ), tab_spanner = c('**Neither use**','**Exclusive e-cig use**','**Dual use**','**Any e-cig use**','**Overall**')) %>%
  bold_labels() %>%
  italicize_levels()

desc_tabs_byoutcomes |> 
  as_gt() |> 
  gt::gtsave(filename = 'C:/path/to/user/outputs/folder/descstats_byoutcomes_tab.docx')

#check differences in main exposures by early-life confounders
desc_tabs_byconfounders <- tbl_merge(tbls = list(
  tbl_summary(subdf[, c(confounders, main_exp)], by=sex, statistic=all_continuous() ~ "{mean} ({sd})", type = all_dichotomous() ~ "categorical", missing = 'no') %>% add_p(),
  tbl_summary(subdf[, c(confounders, main_exp)], by=ethnicity, statistic=all_continuous() ~ "{mean} ({sd})", type = all_dichotomous() ~ "categorical", missing = 'no') %>% add_p(),
  tbl_summary(subdf[, c(confounders, main_exp)], by=hhincome_11, statistic=all_continuous() ~ "{mean} ({sd})", type = all_dichotomous() ~ "categorical", missing = 'no') %>% add_p(),
  tbl_summary(subdf[, c(confounders, main_exp)], by=parent_dailsmk_12, statistic=all_continuous() ~ "{mean} ({sd})", type = all_dichotomous() ~ "categorical", missing = 'no') %>% add_p()
  ), tab_spanner = c('**Sex assigned at birth**','**Ethnicity**','**Household income (11y)**','**Parental smoking (12y)**')) %>%
  bold_labels() %>%
  italicize_levels()

desc_tabs_byconfounders |> 
  as_gt() |> 
  gt::gtsave(filename = 'C:/path/to/user/outputs/folder/descstats_byconfounders_tab.docx')

```

# Box plots showing nicotine use categories and missingness per timepoint

```{r box-plts}
p <- list()

#ns categories by timepoint (complete cases)
ns <- data.frame(n = as.vector(sapply(subdf[,vaps], table, useNA = "ifany")), 
                 cat = rep(c('Exclusive smoking','Dual use','Exclusive e-cig use','No smoking nor e-cig use','Missing'), 5),
                 time = rep(c(22,23,24,28,30), each=5))

ns$cat <- factor(ns$cat, levels=c('Exclusive smoking','Dual use','Exclusive e-cig use','No smoking nor e-cig use','Missing'))

p$ncat <- ggplot(ns, aes(x = time, y = n, fill = cat)) +
  geom_bar(stat="identity", position = 'dodge', colour = 'black') +
  labs(x = '\nTimepoint', y = 'N\n', fill = '') +
  theme_bw() +
  theme(plot.title = element_text(face="bold", hjust=0.5), 
        legend.position = 'bottom', 
        legend.spacing.x = unit(5, 'cm'), 
        text=element_text(size=20, family = 'Times New Roman')) +
  scale_x_continuous(breaks=seq(22,30,1)) +
  scale_y_continuous(limits=c(0,450), breaks=seq(0,450,50)) +
  scale_fill_manual(values=c("grey30", "grey50", "grey70", "grey90", "white")) +
  guides(fill = guide_legend(byrow = TRUE), colour = 'none')

ggsave(p$ncat, width=12,   height=10, filename = 'C:/path/to/user/outputs/folder/ns_percat_plt.png')
```

# Cumulative incidence plots

```{r cuminc-plts}
fit <- survival::survfit(survival::Surv(timeto, firstevent) ~ 1, data = long_impdf)
psta <- as.data.frame(fit$pstate)
colnames(psta) <- fit$states
psta$times <- fit$time
event <- value <- strata <- NULL
pstal <- gather(psta, event, value, -times)
pstal$event[pstal$event %in% '(s0)'] <- 'Exclusive smoking'
pstal$event[pstal$event %in% 'Neither use'] <- 'Stopped nicotine use'
pstal <- rbind(pstal,
               data.frame(times=rep(0,4),
                          event=c('Exclusive smoking','Stopped nicotine use',
                                  'Exclusive e-cigarette use','Dual use'),
                          value=c(1,0,0,0)))
pstal <- pstal[order(pstal$event, pstal$times, pstal$value),]
pstal$event <- factor(pstal$event, 
                      levels=c('Exclusive smoking','Stopped nicotine use',
                               'Exclusive e-cigarette use','Dual use'))


p$cuminc_imp <- ggplot(pstal, aes(times, value, fill=event)) +
  geom_area() + 
  scale_x_continuous(limits=c(0,9), breaks=c(0,1,2,3,7,9)) +
  theme_bw() +
  theme(text=element_text(size = 20, family = 'Times New Roman'), 
        legend.position = 'bottom', legend.box='vertical', 
        legend.key=element_rect(colour="black")) +
  labs(x = '\nApproximate years from 21+ questionnaire\n', y = 'Probability\n', fill = NULL) +
  scale_fill_manual(values=c('Exclusive smoking'='grey100', 'Stopped nicotine use'='grey80', 
                             'Exclusive e-cigarette use'='grey50', 'Dual use'='grey20'))

ggsave(p$cuminc_imp, width=12, height=10, filename = 'C:/path/to/user/outputs/folder/cuminc_stacked_imp_plt.png')
```

# Plots with subdistribution hazard results

```{r produce-surv-plots}
load('C:/path/to/user/outputs/folder/subdistfigdat_adj.rda')

levels(subdistfigdat$imp_w$outcome)[levels(subdistfigdat$imp_w$outcome) %in% 'E-cigarette use'] <- 'Any e-cigarette use'
levels(subdistfigdat$imp_w$outcome)[levels(subdistfigdat$imp_w$outcome) %in% 'Exclusive e-cig use'] <- 'Exclusive e-cigarette use'
levels(subdistfigdat$imp_w$outcome)[levels(subdistfigdat$imp_w$outcome) %in% 'Non-use'] <- 'Stopping nicotine use'

subdistfigdat$imp_w <- subdistfigdat$imp_w[!(subdistfigdat$imp_w$outcome %in% 'Stopping nicotine use' & subdistfigdat$imp_w$ecig_collapsed %in% T),]

subdistfigdat$imp_w$var_label <- recode(subdistfigdat$imp_w$var_label, 
  "Smoking frequency (21y)" = "Smoking frequency<sup><i>a</i></sup> (21y)",
  "Binge drinking, six or more units (20y)" = "Binge drinking frequency<sup><i>b</i></sup> (20y)",
  "Cannabis use (20y)" = "Cannabis use<sup><i>c</i></sup> (20y)",
  "Drug use (20y)" = "Drug use<sup><i>d</i></sup> (20y)",
  "Peer smoking (20y)" = "Peer smoking<sup><i>e</i></sup> (20y)",
  "Educational qualifications (20y)" = "Education<sup><i>f</i></sup> (20y)",
  "Is a parent (21y)" = "Being a parent<sup><i>g</i></sup> (21y)",
  "G1 Townsend deprivation score, quintiles (21y)" = "Neighbourhood deprivation<sup><i>h</i></sup> (21y)",
  "BMI (18y)" = "BMI<sup><i>i</i></sup> (18y)",
  "Frequency of exercise, past year (18y)" = "Exercise frequency<sup><i>j</i></sup> (18y)",
  "Mood and Feelings Questionnaire scores (21y)" = "Depressive symptoms<sup><i>k</i></sup> (21y)"
  )

subdistfigdat$imp_w$var_label <- factor(subdistfigdat$imp_w$var_label, levels=c(
  "Sex assigned at birth", 
  "Ethnicity", 
  "Household income (11y)", 
  "Parental smoking (12y)", 
  "Smoking frequency<sup><i>a</i></sup> (21y)",
  "Binge drinking frequency<sup><i>b</i></sup> (20y)",
  "Cannabis use<sup><i>c</i></sup> (20y)",
  "Drug use<sup><i>d</i></sup> (20y)",
  "Peer smoking<sup><i>e</i></sup> (20y)",
  "Education<sup><i>f</i></sup> (20y)",
  "Being a parent<sup><i>g</i></sup> (21y)",
  "Neighbourhood deprivation<sup><i>h</i></sup> (21y)",
  "BMI<sup><i>i</i></sup> (18y)",
  "Exercise frequency<sup><i>j</i></sup> (18y)",
  "Depressive symptoms<sup><i>k</i></sup> (21y)"))

subdistfigdat$imp_w$y <- interaction(subdistfigdat$imp_w$var_label, subdistfigdat$imp_w$label)
subdistfigdat$imp_w$y <- factor(subdistfigdat$imp_w$y, levels=unique(subdistfigdat$imp_w$y))

subdistfigdat$imp_w <- subdistfigdat$imp_w[!subdistfigdat$imp_w$outcome %in% 'Any e-cigarette use',]

pltit <- function(df){
  df <- df[!df$var %in% c('sex','ethnicity','hhincome_11','parent_dailsmk_12'),]
  df <- df[!df$ref %in% T,]
  pd <- position_dodge(0.8)
  p <- ggplot(df, aes(x=HR, xmin=LCI, xmax=UCI, y=y), colour='black') +
    geom_vline(xintercept = 1, color = "grey40", linetype = "dashed") +
    geom_errorbar(width=.2, position = pd) +
    geom_point(size=4, position = pd) +
    facet_grid(var_label ~ outcome, scales = "free_y", switch = 'y') +
    scale_x_log10() + 
    scale_y_discrete(labels=setNames(df$label, df$y), position = "right") +
    scale_linetype_manual(values=1) +
    scale_shape_manual(values=21) +
    scale_fill_identity() +
    theme_bw() +
    theme(text=element_text(size=30, family = 'Times New Roman'), 
          strip.background = element_blank(), 
          strip.placement = "outside", 
          strip.text.x = element_text(face = 'bold'),
          strip.text.y.left = element_markdown(angle = 0, hjust = 1),
          axis.title.x = element_text(size = 25),
          axis.text.y=element_blank()) +
    labs(x = "\nSubdistribution hazard ratio (SHR)\n", y = '')
  return(p)
}
subdistplts <- lapply(subdistfigdat, pltit)

ggsave(subdistplts$imp_w, width=26,   height=15, filename = 'C:/path/to/user/outputs/folder/subdist_imp_w_plt_nolabs.png')
```

# Get p-values

```{r produce-surv-plots}
#pvals
##calculate the standard error
SE = (u − l)/(2×1.96)

##calculate the test statistic
z = Est/SE

##
P = exp(−0.717×z − 0.416×z2)

e.g. for freqsmk_21 any e-cig

(4.530 - 2.180)/(2*1.96)
3.143/0.5994898
```
